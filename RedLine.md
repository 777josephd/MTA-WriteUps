# Palo Alto Networks Unit 42 RedLine Stealer

Traffic occurred in an AD environment during July, 2023.

LAN Details ;
- LAN segment range: 10[.]7[.]10[.]0/24 (10.7.10.1-10.7.10.255)
- Domain: coolweathercoat[.]com
- Domain controller IP: 10[.]7[.]10[.]9
- Domain controller hostname: WIN-S3WT6LGQFVX
- LAN segment gateway: 10[.]7[.]10[.]1
- LAN segment broadcast address: 10[.]7[.]10[.]255

`QUIZ QUESTIONS`
- What is the date and time in UTC the infection started?
- What is the IP address of the infected Windows client? :: 10.7.10.47
- What is the MAC address of the infected Windows client? :: 80:86:5b:ab:1e:c4
- What is the hostname of the infected Windows client? :: DESKTOP-9PEA63H
- What is the user account name from the infected Windows host? rwalters
- What type of information did this RedLine Stealer try to steal?

Upon opening the PCAP, we can first check the Statistics tabs for Conversations to add to our initial context.

<img width="1828" height="895" alt="screenshot2" src="https://github.com/user-attachments/assets/34ef540e-5a2d-4ee2-9b55-5463df53197e" />


The majority of traffic is from 10[.]7[.]10[.]47, therefore it is safe to assume this is the infected host.
IPs of interest include 92[.]118[.]151[.]9 and 194[.]26[.]135[.]119.

First, we'll focus on investigating the primary suspect IP, 10[.]7[.]10[.]47.
We immediately notice KRB5 protocol packets with a hostname of interest, DESKTOP-9PEA63H.
(Note, two separate strings "DESKTOP-9PEA63H" AND "desktop-9pea63h").

<img width="1829" height="848" alt="screenshot3" src="https://github.com/user-attachments/assets/f4990763-8f69-4bbc-a176-a50ee69df91b" />

<img width="1828" height="940" alt="screenshot4" src="https://github.com/user-attachments/assets/6af50301-e8e4-4c8a-99c5-d375db4b9ea1" />


Focusing on Kerberos packets, we investigate relevant exchanges.
In doing so, we reveal the username of interest, rwalters.

<img width="1828" height="942" alt="screenshot5" src="https://github.com/user-attachments/assets/72a2128a-3a80-43fe-a950-0167bbbf9a80" />

Pivoting to IPs of interest referenced earlier, we can see exchanges between them and our infected host.

<img width="1829" height="937" alt="screenshot6" src="https://github.com/user-attachments/assets/1c7871ed-ceb0-456c-a83f-e99667016446" />

Here, we can see the domain `guiatelefonos[.]com` with suspicious HTTP traffic.
Following the TCP stream of the unencrypted HTTP traffic, we find embedded PowerShell within the User-Agent fields.
These fields seem to be looking for Windows Defender activity and attempting some sort of installation dependent on the previous value.

<img width="1829" height="934" alt="screenshot10" src="https://github.com/user-attachments/assets/92afb564-fa4b-458c-8b5c-3ff05677533d" />


With the collection of all but 2 fields, I consult the answers sheet to move forward.

`ANSWERS`

What is the date and time in UTC the infection started?
What is the IP address of the infected Windows client? :: 10.7.10.47
What is the MAC address of the infected Windows client? :: 80:86:5b:ab:1e:c4
What is the hostname of the infected Windows client? :: DESKTOP-9PEA63H
What is the user account name from the infected Windows host? rwalters
What type of information did this RedLine Stealer try to steal?


Focusing on GET requests and using the filter ` (http.request or tls.handshake.type eq 1) and !(ssdp) ` we learn of another URL, 623start[.]site.
(Note, following the unencrypted TCP flow shows the same PowerShell Windows Defender and Install traffic seen with `guiatelefonos[.]com).

While User-Agent strings can be spoofed by malware or web browser extensions, `WindowsPowerShell` in the User-Agent line is a reliable indicator that this traffic was generated by a PowerShell script.

Continuing to follow the flow, the TCP stream reveals an HTTPS version of the URL, hxxps://guiatelefonos[.]com:443/data/czx[.]jpg.

<img width="1827" height="941" alt="screenshot12" src="https://github.com/user-attachments/assets/4a99a63e-6101-47ee-a359-2b94c73bbbdb" />

<img width="593" height="804" alt="screenshot13" src="https://github.com/user-attachments/assets/8eb1de0c-46d9-4387-91a1-a45306190e21" />

[Article](https://d2lvhbqifib4zm.cloudfront.net/blog/redline-stealer/)

C2 traffic for RedLine Stealer uses TCP traffic over an ephemeral port.
To locate this traffic, we implement the following filter:

` tcp.flags eq 0x0002 and !(tcp.port eq 443) and !(tcp.port eq 80) and !(ip.dst eq 10.7.10.0/24) `

`tcp.flags eq 0x0002` refers to TCP control flags field, hexadecimal representation of SYN flag.
`and !(tcp.port eq 443)` excludes all TCP traffic involving port 443.
`and !(tcp.port eq 80)` excludes all TCP traffic involving port 80.
`and !(ip.dst eq 10.7.10.0/24)` ignores SYN traffic targeting the internal subnet (thus focusing on external traffic).

This reveals the RedLine Stealer C2 traffic.

Initial strings from the TCP stream include the C2 channel at tcp://194[.]26[.]135[.]119:12432/ and URLs using tempuri[.]org. The term "tempuri" is short for "temporary URI," and the domain tempuri[.]org is a placeholder namespace URI used in Microsoft development tools like Visual Studio.

We can clearly see the data from the RedLine C2 is requesting various types of user information from the infected host.

<img width="1829" height="938" alt="screenshot14" src="https://github.com/user-attachments/assets/c21711e6-82ab-4060-838e-e6034c3126b7" />

The list includes wildcard searches on the victim’s desktop and the victim’s Documents folder. This includes text files, Word documents and cryptocurrency wallet files as shown below.

    %userprofile%\Desktop|*.txt,*.doc*,*key*,*wallet*,*seed*|0
    %userprofile%\Documents|*.txt,*.doc*,*key*,*wallet*,*seed*|0

The list then indicates data from different applications, based on their expected locations under the victim’s AppData directory in their user profile. The list is shown below in alphabetical order.

```
    %USERPROFILE%\AppData\Local\360Browser\Browser\User Data
    %USERPROFILE%\AppData\Local\7Star\7Star\User Data
    %USERPROFILE%\AppData\Local\Amigo\User\User Data
    %USERPROFILE%\AppData\Local\Battle.net
    %USERPROFILE%\AppData\Local\BraveSoftware\Brave-Browser\User Data
    %USERPROFILE%\AppData\Local\CatalinaGroup\Citrio\User Data
    %USERPROFILE%\AppData\Local\CentBrowser\User Data
    %USERPROFILE%\AppData\Local\Chedot\User Data
    %USERPROFILE%\AppData\Local\Chromium\User Data
    %USERPROFILE%\AppData\Local\Chromodo\User Data
    %USERPROFILE%\AppData\Local\CocCoc\Browser\User Data
    %USERPROFILE%\AppData\Local\Comodo\Dragon\User Data
    %USERPROFILE%\AppData\Local\Comodo\User Data
    %USERPROFILE%\AppData\Local\Coowon\Coowon\User Data
    %USERPROFILE%\AppData\Local\CryptoTab Browser\User Data
    %USERPROFILE%\AppData\Local\Elements Browser\User Data
    %USERPROFILE%\AppData\Local\Epic Privacy Browser\User Data
    %USERPROFILE%\AppData\Local\Fenrir Inc\Sleipnir5\setting\modules\ChromiumViewer
    %USERPROFILE%\AppData\Local\Google(x86)\Chrome\User Data
    %USERPROFILE%\AppData\Local\Google\Chrome\User Data
    %USERPROFILE%\AppData\Local\Iridium\User Data
    %USERPROFILE%\AppData\Local\K-Melon\User Data
    %USERPROFILE%\AppData\Local\Kometa\User Data
    %USERPROFILE%\AppData\Local\liebao\User Data
    %USERPROFILE%\AppData\Local\Mail.Ru\Atom\User Data
    %USERPROFILE%\AppData\Local\MapleStudio\ChromePlus\User Data
    %USERPROFILE%\AppData\Local\Maxthon3\User Data
    %USERPROFILE%\AppData\Local\Microsoft\Edge\User Data
    %USERPROFILE%\AppData\Local\Nichrome\User Data
    %USERPROFILE%\AppData\Local\NVIDIA Corporation\NVIDIA GeForce Experience
    %USERPROFILE%\AppData\Local\Orbitum\User Data
    %USERPROFILE%\AppData\Local\QIP Surf\User Data
    %USERPROFILE%\AppData\Local\Sputnik\Sputnik\User Data
    %USERPROFILE%\AppData\Local\Steam
    %USERPROFILE%\AppData\Local\Torch\User Data
    %USERPROFILE%\AppData\Local\uCozMedia\Uran\User Data
    %USERPROFILE%\AppData\Local\Uran\User Data
    %USERPROFILE%\AppData\Local\Vivaldi\User Data
    %USERPROFILE%\AppData\Local\Yandex\YandexBrowser\User Data
    %USERPROFILE%\AppData\Roaming\8pecxstudios\Cyberfox
    %USERPROFILE%\AppData\Roaming\Comodo\IceDragon
    %USERPROFILE%\AppData\Roaming\K-Meleon
    %USERPROFILE%\AppData\Roaming\Moonchild Productions\Pale Moon
    %USERPROFILE%\AppData\Roaming\Mozilla\Firefox
    %USERPROFILE%\AppData\Roaming\NETGATE Technologies\BlackHaw
    %USERPROFILE%\AppData\Roaming\Opera Software\
    %USERPROFILE%\AppData\Roaming\Thunderbird
    %USERPROFILE%\AppData\Roaming\Waterfox

```
<img width="1826" height="937" alt="screenshot15" src="https://github.com/user-attachments/assets/902d369a-d98b-4b85-a1bc-a710d1c8b80b" />


We can also see a screenshot of the infected desktop being taken.

<img width="1830" height="941" alt="screenshot16" src="https://github.com/user-attachments/assets/5650cacc-be07-405d-869c-f53a882d9863" />


